<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å•è¯æœ¬</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; background: var(--bg); color: var(--text); }

    .header {
      display: flex; align-items: center; padding: 12px 16px;
      background: var(--bg-card); border-bottom: 1px solid var(--border); gap: 12px;
      position: sticky; top: 0; z-index: 10;
    }
    .header a { color: var(--text); text-decoration: none; font-size: 20px; }
    .header h1 { flex: 1; font-size: 18px; font-weight: 600; }
    .header .stats-text { font-size: 13px; color: var(--text-secondary); }
    .header button { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text); padding: 4px 8px; border-radius: 4px; }
    .header button:hover { background: var(--hover); }

    .feed { max-width: 600px; margin: 0 auto; padding: 12px 16px; }

    /* Review card embedded in feed */
    .review-card {
      background: var(--bg-card); border: 1px solid var(--accent); border-radius: 12px;
      padding: 24px; margin-bottom: 16px; text-align: center;
    }
    .review-card .label { font-size: 12px; color: var(--accent); margin-bottom: 12px; font-weight: 500; }
    .review-card .word { font-size: 28px; font-weight: 600; color: var(--accent); }
    .review-card .phonetic { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .review-card .answer { font-size: 18px; color: var(--text); margin-top: 16px; display: none; }
    .review-card.revealed .answer { display: block; }
    .review-card .tap-hint { font-size: 13px; color: var(--text-secondary); margin-top: 12px; }
    .review-card.revealed .tap-hint { display: none; }
    .review-buttons { display: none; gap: 10px; margin-top: 16px; }
    .review-card.revealed .review-buttons { display: flex; }
    .review-buttons button {
      flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 14px;
      font-weight: 500; cursor: pointer;
    }
    .review-buttons button:active { transform: scale(0.95); }
    .btn-forgot { background: var(--danger, #dc2626); color: white; }
    .btn-hard { background: var(--border); color: var(--text); }
    .btn-good { background: var(--success, #16a34a); color: white; }

    /* Word list items */
    .word-item {
      display: flex; align-items: flex-start; padding: 14px 16px;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      margin-bottom: 8px; gap: 12px;
    }
    .word-item .word-info { flex: 1; min-width: 0; }
    .word-item .word-text { font-size: 16px; font-weight: 600; color: var(--accent); }
    .word-item .word-phonetic { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .word-item .word-trans { font-size: 14px; color: var(--text); margin-top: 4px; line-height: 1.4; }
    .word-item .word-meta { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .word-item .delete-btn {
      background: none; border: none; cursor: pointer; font-size: 16px;
      color: var(--text-secondary); padding: 4px 8px; border-radius: 4px; flex-shrink: 0;
      opacity: 0.5; transition: opacity 0.15s;
    }
    .word-item .delete-btn:hover { opacity: 1; color: var(--danger, #dc2626); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }
    .empty-state a { color: var(--accent); text-decoration: none; }

    .section-title { font-size: 13px; color: var(--text-secondary); margin: 16px 0 8px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html">â†</a>
    <h1>å•è¯æœ¬</h1>
    <span class="stats-text" id="stats-text"></span>
    <button id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
  </div>
  <div class="feed" id="feed"></div>

  <script type="module">
    import { getAllVocabulary, getWordsForReview, updateWordReview, deleteWord } from './db.js'
    import { toggleTheme, getTheme } from './theme.js'
    import { isDropboxConfigured, isLoggedIn } from './dropbox.js'
    import { pushToDropbox } from './sync.js'

    const themeBtn = document.getElementById('theme-toggle')
    themeBtn.textContent = getTheme() === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'
    themeBtn.addEventListener('click', () => {
      const t = toggleTheme()
      themeBtn.textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'
    })

    let syncTimeout = null
    function debouncedSync() {
      if (!isDropboxConfigured() || !isLoggedIn()) return
      if (syncTimeout) clearTimeout(syncTimeout)
      syncTimeout = setTimeout(() => pushToDropbox().catch(() => {}), 3000)
    }

    const feed = document.getElementById('feed')
    const statsText = document.getElementById('stats-text')
    let reviewCards = []
    let reviewIndex = 0

    async function render() {
      const allWords = await getAllVocabulary()
      reviewCards = await getWordsForReview(50)
      reviewIndex = 0

      statsText.textContent = `${allWords.length} è¯`

      if (allWords.length === 0) {
        feed.innerHTML = `<div class="empty-state"><h2>è¿˜æ²¡æœ‰å•è¯</h2><p>åœ¨é˜…è¯»æ—¶é€‰ä¸­è‹±æ–‡å•è¯å³å¯è‡ªåŠ¨æ·»åŠ </p><a href="index.html">â† è¿”å›ä¹¦æ¶</a></div>`
        return
      }

      feed.innerHTML = ''

      // Insert first review card if available
      if (reviewCards.length > 0) {
        insertReviewCard()
      }

      // Section: all words sorted by most recent
      const sorted = [...allWords].sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0))

      const title = document.createElement('div')
      title.className = 'section-title'
      title.textContent = `å…¨éƒ¨å•è¯ (${sorted.length})`
      feed.appendChild(title)

      for (const w of sorted) {
        const el = document.createElement('div')
        el.className = 'word-item'
        const date = w.addedAt ? new Date(w.addedAt).toLocaleDateString('zh-CN') : ''
        const bookInfo = w.book ? ` Â· ${w.book}` : ''
        el.innerHTML = `
          <div class="word-info">
            <div class="word-text">${esc(w.word)}</div>
            ${w.phonetic ? `<div class="word-phonetic">/${esc(w.phonetic)}/</div>` : ''}
            <div class="word-trans">${esc(w.translation || '(æ— ç¿»è¯‘)')}</div>
            <div class="word-meta">${date}${bookInfo}${w.count > 1 ? ` Â· æŸ¥è¿‡ ${w.count} æ¬¡` : ''}</div>
          </div>
          <button class="delete-btn" title="åˆ é™¤">âœ•</button>
        `
        el.querySelector('.delete-btn').addEventListener('click', async () => {
          await deleteWord(w.word)
          el.remove()
          debouncedSync()
          const remaining = feed.querySelectorAll('.word-item').length
          statsText.textContent = `${remaining} è¯`
        })
        feed.appendChild(el)
      }
    }

    function insertReviewCard() {
      if (reviewIndex >= reviewCards.length) return
      const w = reviewCards[reviewIndex]
      const el = document.createElement('div')
      el.className = 'review-card'
      el.id = 'current-review'
      el.innerHTML = `
        <div class="label">ğŸ“– å¤ä¹  (${reviewIndex + 1}/${reviewCards.length})</div>
        <div class="word">${esc(w.word)}</div>
        <div class="answer">${esc(w.translation || '(æ— ç¿»è¯‘)')}</div>
        <div class="tap-hint">ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ</div>
        <div class="review-buttons">
          <button class="btn-forgot" data-q="1">å¿˜äº†</button>
          <button class="btn-hard" data-q="3">æƒ³èµ·æ¥äº†</button>
          <button class="btn-good" data-q="5">ç§’ç­”</button>
        </div>
      `
      el.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') return
        el.classList.add('revealed')
      })
      el.querySelectorAll('.review-buttons button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const quality = parseInt(btn.dataset.q)
          await updateWordReview(w.word, quality)
          debouncedSync()
          reviewIndex++
          el.remove()
          if (reviewIndex < reviewCards.length) {
            // Insert next review card at top of feed
            const firstChild = feed.firstChild
            insertReviewCardBefore(firstChild)
          }
        })
      })
      feed.prepend(el)
    }

    function insertReviewCardBefore(ref) {
      if (reviewIndex >= reviewCards.length) return
      const w = reviewCards[reviewIndex]
      const el = document.createElement('div')
      el.className = 'review-card'
      el.innerHTML = `
        <div class="label">ğŸ“– å¤ä¹  (${reviewIndex + 1}/${reviewCards.length})</div>
        <div class="word">${esc(w.word)}</div>
        <div class="answer">${esc(w.translation || '(æ— ç¿»è¯‘)')}</div>
        <div class="tap-hint">ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ</div>
        <div class="review-buttons">
          <button class="btn-forgot" data-q="1">å¿˜äº†</button>
          <button class="btn-hard" data-q="3">æƒ³èµ·æ¥äº†</button>
          <button class="btn-good" data-q="5">ç§’ç­”</button>
        </div>
      `
      el.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') return
        el.classList.add('revealed')
      })
      el.querySelectorAll('.review-buttons button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const quality = parseInt(btn.dataset.q)
          await updateWordReview(w.word, quality)
          debouncedSync()
          reviewIndex++
          el.remove()
          if (reviewIndex < reviewCards.length) {
            const sectionTitle = feed.querySelector('.section-title')
            insertReviewCardBefore(sectionTitle)
          }
        })
      })
      feed.insertBefore(el, ref)
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML }

    render()
  </script>
</body>
</html>
